<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Polygram ¬∑ Trade Predictions</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'Benzin';
      src: url('https://fonts.cdnfonts.com/s/29189/Benzin-ExtraBold.woff') format('woff');
      font-weight: 800;
      font-style: normal;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg: #d4eef4;
      --card: #c8e8f0;
      --text: #1a3a4a;
      --text-muted: #4a7080;
      --accent: #1e3a5f;
      --accent-light: #a8f0c8;
      --green: #7cf0a8;
      --green-soft: #a8f0c8;
      --red: #ef4444;
      --border: #b8dce8;
      --radius: 24px;
      --radius-sm: 16px;
      --shadow: none;
    }

    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* Splash Screen */
    .splash-screen {
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.4s ease;
    }
    .splash-screen.hidden { opacity: 0; pointer-events: none; }
    
    .splash-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 32px;
    }
    .splash-logo-icon {
      font-size: 32px;
    }
    .splash-logo-text {
      font-family: 'Benzin', 'DM Sans', sans-serif;
      font-size: 42px;
      font-weight: 800;
      color: var(--text);
      letter-spacing: -0.02em;
    }
    
    .splash-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Onboarding Screen */
    .onboarding-screen {
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9998;
      padding: 20px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .onboarding-screen.visible { opacity: 1; pointer-events: auto; }
    
    .onboarding-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 32px;
      max-width: 360px;
      width: 100%;
      text-align: center;
    }
    .onboarding-logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .onboarding-logo-icon {
      font-size: 24px;
    }
    .onboarding-logo-text {
      font-family: 'Benzin', 'DM Sans', sans-serif;
      font-size: 28px;
      font-weight: 800;
      color: var(--text);
    }
    .onboarding-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text);
    }
    .onboarding-subtitle {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 24px;
      line-height: 1.5;
    }
    
    .feature-list {
      text-align: left;
      margin-bottom: 24px;
    }
    .feature-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg);
      border-radius: var(--radius-sm);
      margin-bottom: 10px;
    }
    .feature-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: var(--accent);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }
    .feature-text {
      font-size: 13px;
      color: var(--text);
      line-height: 1.4;
    }
    
    .passkey-input {
      width: 100%;
      padding: 14px;
      font-size: 15px;
      font-family: inherit;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg);
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 12px;
      transition: border-color 0.2s;
    }
    .passkey-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    .passkey-input.error {
      border-color: var(--red);
      animation: shake 0.4s ease;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      75% { transform: translateX(8px); }
    }
    
    .passkey-error {
      color: var(--red);
      font-size: 12px;
      margin-bottom: 12px;
      display: none;
    }
    .passkey-error.visible { display: block; }
    
    .passkey-btn {
      width: 100%;
      padding: 14px;
      font-size: 15px;
      font-weight: 600;
      font-family: inherit;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: transform 0.2s, opacity 0.2s;
    }
    .passkey-btn:active { transform: scale(0.98); }
    .passkey-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    
    .passkey-hint {
      margin-top: 16px;
      font-size: 12px;
      color: var(--text-muted);
    }
    .passkey-hint a {
      color: var(--accent);
      text-decoration: none;
    }

    /* Main App */
    .app-shell {
      padding: 20px 16px 100px;
      max-width: 480px;
      margin: 0 auto;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .app-shell.visible { opacity: 1; }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      padding: 8px 0;
    }
    .header-logo {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .header-logo-icon {
      font-size: 20px;
    }
    .header-logo-text {
      font-family: 'Benzin', 'DM Sans', sans-serif;
      font-size: 26px;
      font-weight: 800;
      color: var(--text);
      letter-spacing: -0.02em;
    }

    /* Cards */
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 16px;
    }
    .card-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 6px;
    }

    /* Balance Card */
    .balance-card {
      position: relative;
    }
    .balance-top-bar {
      background: var(--green);
      height: 48px;
      border-radius: 30px;
      margin-bottom: 16px;
    }
    .balance-amount {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text);
    }
    .balance-breakdown {
      background: var(--bg);
      padding: 14px 18px;
      border-radius: 30px;
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }
    .balance-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--accent);
    }

    /* Wallet Card */
    .wallet-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text);
    }
    .wallet-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 12px;
    }
    .wallet-row {
      background: var(--bg);
      border-radius: 16px;
      padding: 12px 16px;
    }
    .wallet-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .wallet-icon {
      font-size: 14px;
      font-weight: 700;
    }
    .wallet-address-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .wallet-address {
      font-size: 13px;
      font-family: 'SF Mono', Monaco, monospace;
      color: var(--text);
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .copy-btn {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 8px;
      cursor: pointer;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .copy-btn:hover {
      background: var(--green);
      color: var(--text);
      border-color: var(--green);
    }
    .copy-btn:active {
      transform: scale(0.95);
    }
    .copy-btn.copied {
      background: var(--green);
      color: var(--text);
      border-color: var(--green);
    }
    .wallet-status {
      background: var(--accent);
      color: white;
      height: 40px;
      border-radius: 30px;
      padding: 0 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      margin-bottom: 12px;
    }
    .wallet-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    .wallet-actions-bottom {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .wallet-btn {
      padding: 16px;
      border-radius: 30px;
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.2s;
      border: none;
    }
    .wallet-btn:active { transform: scale(0.98); }
    .wallet-btn.green {
      background: var(--green);
      color: var(--text);
    }
    .wallet-btn.dark {
      background: var(--accent);
      color: white;
    }

    /* Markets Card */
    .markets-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .markets-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
    }
    .mode-chips {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 16px;
    }
    .mode-chip {
      padding: 14px 16px;
      border-radius: 30px;
      font-size: 13px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      background: var(--accent);
      border: none;
      color: white;
      transition: all 0.2s;
    }
    .mode-chip.active {
      background: var(--green);
      color: var(--text);
    }
    
    .markets-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Market Item */
    .market-item {
      display: flex;
      gap: 12px;
      padding: 14px;
      background: var(--bg);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: transform 0.2s;
    }
    .market-item:active { transform: scale(0.99); }
    .market-info {
      flex: 1;
      min-width: 0;
    }
    .market-question {
      font-size: 14px;
      font-weight: 500;
      line-height: 1.4;
      margin-bottom: 6px;
      color: var(--text);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .market-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 12px;
      color: var(--text-muted);
    }
    .market-odds {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }
    .odds-yes {
      background: var(--green);
      color: var(--text);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }
    .odds-vol {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Bottom Nav */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card);
      padding: 12px 20px 24px;
      display: flex;
      justify-content: space-around;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .bottom-nav.visible { opacity: 1; }
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-muted);
      font-family: inherit;
      padding: 8px 16px;
    }
    .nav-item.active { color: var(--accent); }
    .nav-item .nav-icon {
      font-size: 22px;
    }
    .nav-item span {
      font-size: 11px;
      font-weight: 500;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .modal-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }
    .modal {
      background: var(--card);
      border-radius: var(--radius) var(--radius) 0 0;
      padding: 24px;
      width: 100%;
      max-width: 480px;
      max-height: 85vh;
      overflow-y: auto;
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }
    .modal-overlay.visible .modal {
      transform: translateY(0);
    }
    .modal-handle {
      width: 40px;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin: 0 auto 20px;
    }
    .modal-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text);
    }
    .modal-subtitle {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 20px;
    }
    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bg);
      border: none;
      font-size: 18px;
      cursor: pointer;
    }

    /* Trade Modal */
    .trade-market-info {
      display: flex;
      gap: 12px;
      padding: 16px;
      background: var(--bg);
      border-radius: var(--radius-sm);
      margin-bottom: 20px;
    }
    .trade-market-img {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      object-fit: cover;
    }
    .trade-market-question {
      font-size: 14px;
      font-weight: 500;
      line-height: 1.4;
      color: var(--text);
    }
    
    .trade-sides {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }
    .trade-side {
      padding: 16px;
      border-radius: var(--radius-sm);
      text-align: center;
      cursor: pointer;
      border: 2px solid var(--border);
      transition: all 0.2s;
      background: var(--bg);
    }
    .trade-side.yes.active { 
      border-color: var(--green); 
      background: var(--green-soft);
    }
    .trade-side.no.active { 
      border-color: var(--red); 
      background: #fef2f2;
    }
    .trade-side-label {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text);
    }
    .trade-side-price {
      font-size: 24px;
      font-weight: 700;
    }
    .trade-side.yes .trade-side-price { color: #22c55e; }
    .trade-side.no .trade-side-price { color: #ef4444; }
    
    .trade-amount {
      margin-bottom: 20px;
    }
    .trade-amount label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    .trade-amount input {
      width: 100%;
      padding: 16px;
      font-size: 18px;
      font-family: inherit;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      text-align: center;
      background: var(--bg);
    }
    .trade-amount input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .trade-summary {
      padding: 16px;
      background: var(--bg);
      border-radius: var(--radius-sm);
      margin-bottom: 20px;
    }
    .trade-summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .trade-summary-row:last-child { margin-bottom: 0; }
    .trade-summary-row span:first-child { color: var(--text-muted); }
    .trade-summary-row span:last-child { font-weight: 600; color: var(--text); }
    
    .trade-submit {
      width: 100%;
      padding: 16px;
      font-size: 16px;
      font-weight: 600;
      font-family: inherit;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 30px;
      cursor: pointer;
    }
    .trade-submit:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Loading State */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: var(--text-muted);
      font-size: 14px;
    }
  </style>
</head>
<body>
  <!-- Splash Screen -->
  <div class="splash-screen" id="splashScreen">
    <div class="splash-logo">
      <span class="splash-logo-icon">‚ú¶</span>
      <span class="splash-logo-text">Polygram</span>
    </div>
    <div class="splash-spinner"></div>
  </div>

  <!-- Onboarding Screen -->
  <div class="onboarding-screen" id="onboardingScreen">
    <div class="onboarding-card">
      <div class="onboarding-logo">
        <span class="onboarding-logo-icon">‚ú¶</span>
        <span class="onboarding-logo-text">Polygram</span>
      </div>
      <h2 class="onboarding-title">Welcome to Polygram</h2>
      <p class="onboarding-subtitle">Trade prediction markets directly from Telegram. Fast, simple, powerful.</p>
      
      <div class="feature-list">
        <div class="feature-item">
          <div class="feature-icon">‚ö°</div>
          <div class="feature-text">Instant trades on Polymarket via custodial wallet</div>
        </div>
        <div class="feature-item">
          <div class="feature-icon">üìä</div>
          <div class="feature-text">Real-time markets, trending events, live odds</div>
        </div>
        <div class="feature-item">
          <div class="feature-icon">üîê</div>
          <div class="feature-text">Secure wallet with USDC on Polygon network</div>
        </div>
      </div>
      
      <input type="text" class="passkey-input" id="passkeyInput" placeholder="Enter passkey" maxlength="20" />
      <div class="passkey-error" id="passkeyError">Invalid passkey. Please try again.</div>
      <button class="passkey-btn" id="passkeyBtn">Continue</button>
      
      <p class="passkey-hint">Don't have a passkey? <a href="https://t.me/publiclabs" target="_blank">Join our Telegram</a></p>
    </div>
  </div>

  <!-- Main App -->
  <div class="app-shell" id="appShell">
    <!-- Header -->
    <header class="header">
      <div class="header-logo">
        <span class="header-logo-icon">‚ú¶</span>
        <span class="header-logo-text">Polygram</span>
      </div>
    </header>

    <!-- Balance Card -->
    <div class="card balance-card">
      <div class="balance-top-bar"></div>
      <div class="balance-amount" id="totalBalance">$0.00</div>
      <div class="balance-breakdown" id="balanceBreakdown">
        USDC: <span id="usdcBalance">$0.00</span> | Positions: <span id="positionsValue">$0.00</span>
      </div>
      <div class="balance-dot"></div>
    </div>

    <!-- Wallet Card -->
    <div class="card">
      <div class="wallet-section">
        <div class="wallet-row">
          <div class="wallet-label">
            <span class="wallet-icon">‚óé</span>
            <span>SOL Wallet</span>
          </div>
          <div class="wallet-address-row">
            <span class="wallet-address" id="solWalletAddress">Loading...</span>
            <button class="copy-btn" id="copySolBtn" title="Copy SOL address">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
            </button>
          </div>
        </div>
        <div class="wallet-row">
          <div class="wallet-label">
            <span class="wallet-icon">$</span>
            <span>USDC Wallet</span>
          </div>
          <div class="wallet-address-row">
            <span class="wallet-address" id="usdcWalletAddress">Loading...</span>
            <button class="copy-btn" id="copyUsdcBtn" title="Copy USDC address">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
      <div class="wallet-status" id="walletStatusBar">Checking status...</div>
      <div class="wallet-actions">
        <button class="wallet-btn green" id="depositBtn">Deposit</button>
        <button class="wallet-btn dark" id="withdrawBtn">Withdraw</button>
      </div>
      <div class="wallet-actions-bottom">
        <button class="wallet-btn dark" id="tradeBtn">Trade</button>
        <button class="wallet-btn dark" id="refreshButton">Refresh</button>
      </div>
    </div>

    <!-- Markets Card -->
    <div class="card">
      <div class="mode-chips">
        <button class="mode-chip active" data-kind="trending">üî• Trending</button>
        <button class="mode-chip" data-kind="volume">üìà Volume</button>
        <button class="mode-chip" data-kind="new">üÜï New</button>
        <button class="mode-chip" data-kind="sports">‚öΩ Sports</button>
      </div>
      
      <div class="markets-list" id="marketsList">
        <div class="loading">Loading markets...</div>
      </div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <nav class="bottom-nav" id="bottomNav">
    <button class="nav-item active" data-tab="home">
      <span class="nav-icon">üè†</span>
      <span>Home</span>
    </button>
    <button class="nav-item" data-tab="portfolio">
      <span class="nav-icon">üìä</span>
      <span>Portfolio</span>
    </button>
    <button class="nav-item" data-tab="history">
      <span class="nav-icon">üìã</span>
      <span>History</span>
    </button>
  </nav>

  <!-- Trade Modal -->
  <div class="modal-overlay" id="tradeModal">
    <div class="modal">
      <div class="modal-handle"></div>
      <h3 class="modal-title">Place Trade</h3>
      <p class="modal-subtitle">Select your position and amount</p>
      
      <div class="trade-market-info" id="tradeMarketInfo">
        <img class="trade-market-img" id="tradeMarketImg" src="" alt="" />
        <div class="trade-market-question" id="tradeMarketQuestion"></div>
      </div>
      
      <div class="trade-sides">
        <div class="trade-side yes active" data-side="yes">
          <div class="trade-side-label">Yes</div>
          <div class="trade-side-price" id="yesPrice">--¬¢</div>
        </div>
        <div class="trade-side no" data-side="no">
          <div class="trade-side-label">No</div>
          <div class="trade-side-price" id="noPrice">--¬¢</div>
        </div>
      </div>
      
      <div class="trade-amount">
        <label>Amount (USDC)</label>
        <input type="number" id="tradeAmount" placeholder="10.00" min="1" step="1" />
      </div>
      
      <div class="trade-summary">
        <div class="trade-summary-row">
          <span>Shares</span>
          <span id="tradeShares">0</span>
        </div>
        <div class="trade-summary-row">
          <span>Avg Price</span>
          <span id="tradeAvgPrice">--¬¢</span>
        </div>
        <div class="trade-summary-row">
          <span>Potential Return</span>
          <span id="tradePotential">$0.00</span>
        </div>
      </div>
      
      <button class="trade-submit" id="tradeSubmit" disabled>Connect Wallet First</button>
    </div>
  </div>

  <script>
    // =====================
    // STATE
    // =====================
    const state = {
      telegramId: null,
      wallet: null,
      markets: [],
      selectedMarket: null,
      tradeSide: 'yes',
    };

    // =====================
    // TELEGRAM INIT
    // =====================
    function initTelegram() {
      if (window.Telegram?.WebApp) {
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        state.telegramId = tg.initDataUnsafe?.user?.id || `demo_${Date.now()}`;
      } else {
        state.telegramId = `demo_${Date.now()}`;
      }
      console.log('Telegram ID:', state.telegramId);
    }

    // =====================
    // UTILS
    // =====================
    function shortAddr(addr) {
      if (!addr) return '...';
      return `${addr.slice(0, 6)}...${addr.slice(-4)}`;
    }

    function formatUSD(num) {
      return `$${Number(num || 0).toFixed(2)}`;
    }

    function formatVolume(num) {
      if (!num) return '$0';
      if (num >= 1000000) return `$${(num / 1000000).toFixed(1)}M`;
      if (num >= 1000) return `$${(num / 1000).toFixed(1)}K`;
      return `$${num.toFixed(0)}`;
    }

    // =====================
    // ONBOARDING FLOW
    // =====================
    const STORAGE_KEY = 'polygram_access';
    const VALID_PASSKEYS = ['EARLYBIRD', 'POLYGRAM2024', 'TRADEPRO', 'BETAACCESS', 'PUBLICLABS'];

    function checkAccess() {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('bypass') === 'true') return true;
      
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        try {
          const data = JSON.parse(stored);
          if (data.validated) return true;
        } catch (e) {}
      }
      return false;
    }

    function grantAccess(passkey) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        validated: true,
        passkey: passkey,
        timestamp: Date.now()
      }));
    }

    function showSplash() {
      document.getElementById('splashScreen').classList.remove('hidden');
    }

    function hideSplash() {
      document.getElementById('splashScreen').classList.add('hidden');
    }

    function showOnboarding() {
      document.getElementById('onboardingScreen').classList.add('visible');
    }

    function hideOnboarding() {
      document.getElementById('onboardingScreen').classList.remove('visible');
    }

    function showMainApp() {
      document.getElementById('appShell').classList.add('visible');
      document.getElementById('bottomNav').classList.add('visible');
      bootstrapApp();
    }

    function initOnboarding() {
      const input = document.getElementById('passkeyInput');
      const btn = document.getElementById('passkeyBtn');
      const error = document.getElementById('passkeyError');

      btn.addEventListener('click', () => {
        const passkey = input.value.trim().toUpperCase();
        
        if (VALID_PASSKEYS.includes(passkey)) {
          btn.textContent = '‚úì';
          grantAccess(passkey);
          setTimeout(() => {
            hideOnboarding();
            showMainApp();
          }, 500);
        } else {
          input.classList.add('error');
          error.classList.add('visible');
          setTimeout(() => {
            input.classList.remove('error');
          }, 400);
        }
      });

      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') btn.click();
      });

      input.addEventListener('input', () => {
        error.classList.remove('visible');
      });
    }

    // =====================
    // WALLET MANAGEMENT
    // =====================
    async function loadWallet() {
      try {
        console.log('Loading wallet for:', state.telegramId);
        const resp = await fetch(`/api/wallet?telegram_id=${state.telegramId}&action=get`);
        const data = await resp.json();
        console.log('Wallet response:', data);

        if (data.success && data.wallet) {
          state.wallet = data.wallet;
          
          // Display SOL wallet
          const solAddr = data.wallet.solana || 'Not created';
          document.getElementById('solWalletAddress').textContent = solAddr;
          
          // Display USDC wallet (Polygon)
          const usdcAddr = data.wallet.polygon || 'Not created';
          document.getElementById('usdcWalletAddress').textContent = usdcAddr;
          
          // Update status
          document.getElementById('walletStatusBar').textContent = data.wallet.clobRegistered ? '‚úì Ready to trade' : 'Wallets created';
          
          // Setup copy buttons
          setupCopyButton('copySolBtn', data.wallet.solana);
          setupCopyButton('copyUsdcBtn', data.wallet.polygon);
          
          loadBalance();
        } else {
          document.getElementById('solWalletAddress').textContent = 'No wallet yet';
          document.getElementById('usdcWalletAddress').textContent = 'No wallet yet';
          document.getElementById('walletStatusBar').textContent = 'Click Deposit to create';
        }
      } catch (err) {
        console.error('Wallet error:', err);
        document.getElementById('solWalletAddress').textContent = 'Error';
        document.getElementById('usdcWalletAddress').textContent = 'Error';
        document.getElementById('walletStatusBar').textContent = err.message;
      }
    }

    function setupCopyButton(btnId, address) {
      const btn = document.getElementById(btnId);
      if (!btn || !address) return;
      
      btn.onclick = async () => {
        try {
          await navigator.clipboard.writeText(address);
          btn.classList.add('copied');
          btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
          
          setTimeout(() => {
            btn.classList.remove('copied');
            btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
          }, 2000);
        } catch (err) {
          console.error('Copy failed:', err);
          // Fallback for older browsers
          const textArea = document.createElement('textarea');
          textArea.value = address;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          
          btn.classList.add('copied');
          setTimeout(() => btn.classList.remove('copied'), 2000);
        }
      };
    }

    async function loadBalance() {
      try {
        const resp = await fetch(`/api/balances?telegram_id=${state.telegramId}`);
        const data = await resp.json();
        console.log('Balance response:', data);

        if (data.success) {
          document.getElementById('usdcBalance').textContent = formatUSD(data.usdc);
          document.getElementById('positionsValue').textContent = formatUSD(data.positions);
          document.getElementById('totalBalance').textContent = formatUSD(data.total);
        }
      } catch (err) {
        console.error('Balance error:', err);
      }
    }

    // =====================
    // MARKETS
    // =====================
    async function fetchMarkets(kind = 'trending') {
      const list = document.getElementById('marketsList');
      list.innerHTML = '<div class="loading">Loading markets...</div>';

      try {
        console.log('[fetchMarkets] Fetching:', kind);
        const apiUrl = `/api/markets?kind=${kind}&limit=15`;
        console.log('[fetchMarkets] URL:', apiUrl);
        
        const resp = await fetch(apiUrl);
        console.log('[fetchMarkets] Status:', resp.status, resp.statusText);
        
        if (!resp.ok) {
          const errorText = await resp.text();
          console.error('[fetchMarkets] Error response:', errorText);
          throw new Error(`HTTP ${resp.status}: ${errorText.substring(0, 100)}`);
        }
        
        const data = await resp.json();
        console.log('[fetchMarkets] Response data:', data);
        console.log('[fetchMarkets] Markets count:', data.markets?.length || 0);
        
        const markets = data.markets || [];
        
        if (markets.length > 0) {
          console.log('[fetchMarkets] First market:', markets[0]);
          state.markets = markets;
          renderMarkets(markets);
        } else {
          console.log('[fetchMarkets] No markets in response');
          list.innerHTML = `<div class="loading">No markets found. <br><small style="color:var(--text-muted)">API responded but returned 0 markets</small></div>`;
        }
      } catch (err) {
        console.error('[fetchMarkets] Error:', err);
        list.innerHTML = `
          <div class="loading" style="color:#ef4444;">
            Failed to load markets<br>
            <small style="color:var(--text-muted)">${err.message}</small>
          </div>
        `;
      }
    }

    function renderMarkets(markets) {
      const list = document.getElementById('marketsList');
      
      list.innerHTML = markets.map(m => {
        const prices = m.outcomePrices || [];
        const yesPrice = prices[0] ? (parseFloat(prices[0]) * 100).toFixed(0) : '--';
        const vol = m.volume24hr || m.volume || 0;
        
        return `
          <div class="market-item" data-id="${m.id}">
            <div class="market-info">
              <div class="market-question">${m.question}</div>
              <div class="market-meta">
                <span>Vol: ${formatVolume(vol)}</span>
              </div>
            </div>
            <div class="market-odds">
              <div class="odds-yes">${yesPrice}¬¢</div>
              <div class="odds-vol">Yes</div>
            </div>
          </div>
        `;
      }).join('');

      // Add click handlers
      list.querySelectorAll('.market-item').forEach(item => {
        item.addEventListener('click', () => {
          const market = markets.find(m => m.id === item.dataset.id);
          if (market) openTradeModal(market);
        });
      });
    }

    // =====================
    // TRADE MODAL
    // =====================
    function openTradeModal(market) {
      state.selectedMarket = market;
      state.tradeSide = 'yes';

      const prices = market.outcomePrices || [];
      const yesPrice = prices[0] ? (parseFloat(prices[0]) * 100).toFixed(0) : '--';
      const noPrice = prices[1] ? (parseFloat(prices[1]) * 100).toFixed(0) : '--';

      document.getElementById('tradeMarketImg').src = market.image || market.icon || '';
      document.getElementById('tradeMarketQuestion').textContent = market.question;
      document.getElementById('yesPrice').textContent = `${yesPrice}¬¢`;
      document.getElementById('noPrice').textContent = `${noPrice}¬¢`;
      document.getElementById('tradeAmount').value = '';
      
      updateTradeSummary();
      
      document.getElementById('tradeModal').classList.add('visible');
    }

    function closeTradeModal() {
      document.getElementById('tradeModal').classList.remove('visible');
      state.selectedMarket = null;
    }

    function updateTradeSummary() {
      const amount = parseFloat(document.getElementById('tradeAmount').value) || 0;
      const prices = state.selectedMarket?.outcomePrices || [];
      const priceIdx = state.tradeSide === 'yes' ? 0 : 1;
      const price = prices[priceIdx] ? parseFloat(prices[priceIdx]) : 0.5;
      
      const shares = price > 0 ? (amount / price).toFixed(2) : 0;
      const potential = (shares * 1).toFixed(2);
      
      document.getElementById('tradeShares').textContent = shares;
      document.getElementById('tradeAvgPrice').textContent = `${(price * 100).toFixed(0)}¬¢`;
      document.getElementById('tradePotential').textContent = `$${potential}`;
      
      const btn = document.getElementById('tradeSubmit');
      if (state.wallet && amount > 0) {
        btn.disabled = false;
        btn.textContent = `Buy ${state.tradeSide.toUpperCase()} ¬∑ $${amount.toFixed(2)}`;
      } else if (!state.wallet) {
        btn.disabled = true;
        btn.textContent = 'Create Wallet First';
      } else {
        btn.disabled = true;
        btn.textContent = 'Enter Amount';
      }
    }

    // =====================
    // INIT
    // =====================
    function initModeChips() {
      document.querySelectorAll('.mode-chip[data-kind]').forEach(chip => {
        chip.addEventListener('click', () => {
          document.querySelectorAll('.mode-chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          fetchMarkets(chip.dataset.kind);
        });
      });
    }

    function initTradeModal() {
      // Close on backdrop click
      document.getElementById('tradeModal').addEventListener('click', (e) => {
        if (e.target.id === 'tradeModal') closeTradeModal();
      });

      // Trade side selection
      document.querySelectorAll('.trade-side').forEach(side => {
        side.addEventListener('click', () => {
          document.querySelectorAll('.trade-side').forEach(s => s.classList.remove('active'));
          side.classList.add('active');
          state.tradeSide = side.dataset.side;
          updateTradeSummary();
        });
      });

      // Amount input
      document.getElementById('tradeAmount').addEventListener('input', updateTradeSummary);

      // Submit
      document.getElementById('tradeSubmit').addEventListener('click', async () => {
        alert('Trading coming soon! Wallet needs USDC and CLOB registration first.');
      });
    }

    async function bootstrapApp() {
      console.log('Bootstrapping app...');
      initTelegram();
      initModeChips();
      initTradeModal();

      document.getElementById('refreshButton').addEventListener('click', () => {
        loadWallet();
        fetchMarkets('trending');
      });

      await loadWallet();
      await fetchMarkets('trending');
      console.log('Bootstrap complete');
    }

    // =====================
    // START
    // =====================
    document.addEventListener('DOMContentLoaded', () => {
      initOnboarding();
      showSplash();

      setTimeout(() => {
        hideSplash();
        if (checkAccess()) {
          showMainApp();
        } else {
          showOnboarding();
        }
      }, 1500);
    });
  </script>
</body>
</html>
