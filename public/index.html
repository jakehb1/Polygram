<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <meta charset="UTF-8" />
  <title>Polyamorous ‚Äì Polymarket Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      /* Light theme defaults */
      --bg: #f4f4f5;
      --bg-radial-1: #e0f2fe;
      --bg-radial-2: #f4f4f5;
      --bg-radial-3: #e5e7eb;
      --card-bg: #ffffff;
      --card-outline: rgba(148, 163, 184, 0.5);
      --card-glow: rgba(129, 140, 248, 0.27);
      --text-primary: #020617;
      --text-secondary: #6b7280;
      --button-bg: #f9fafb;
      --button-border: #e5e7eb;
      --button-text: #020617;
      --pill-bg: #f1f5f9;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --accent-strong: #4f46e5;
      --danger: #ef4444;
      --radius-card: 20px;
    }

    /* Dark theme overrides when body has .theme-dark */
    body.theme-dark {
      --bg: #020617;
      --bg-radial-1: #0b1120;
      --bg-radial-2: #020617;
      --bg-radial-3: #000000;
      --card-bg: rgba(15, 23, 42, 0.92);
      --card-outline: rgba(30, 64, 175, 0.45);
      --card-glow: rgba(59, 130, 246, 0.4);
      --text-primary: #e5e7eb;
      --text-secondary: #9ca3af;
      --button-bg: #020617;
      --button-border: #1f2937;
      --button-text: #e5e7eb;
      --pill-bg: #020617;
      --accent: #38bdf8;
      --accent-soft: #0f172a;
      --accent-strong: #6366f1;
      --danger: #f97373;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at 0% 0%, var(--bg-radial-1) 0, transparent 45%),
        radial-gradient(circle at 100% 0%, var(--bg-radial-2) 0, transparent 45%),
        radial-gradient(circle at 50% 100%, var(--bg-radial-3) 0, var(--bg) 60%);
      color: var(--text-primary);
      transition: background 0.25s ease, color 0.25s ease;
      min-height: 100vh;
    }

    .app {
      max-width: 420px;
      margin: 4px auto 40px;
    }

    /* Brand / logo */
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 4px 0 14px;
      padding: 10px 12px;
      border-radius: 999px;
      background: radial-gradient(circle at 0 0, rgba(251, 191, 36, 0.22), transparent 60%),
                  rgba(248, 250, 252, 0.85);
      border: 1px solid rgba(226, 232, 240, 0.9);
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.08);
    }

    body.theme-dark .brand {
      background: radial-gradient(circle at 0 0, rgba(250, 204, 21, 0.16), transparent 60%),
                  rgba(15, 23, 42, 0.96);
      border-color: rgba(30, 64, 175, 0.7);
      box-shadow: 0 14px 26px rgba(15, 23, 42, 0.6);
    }

    .brand-mark {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: conic-gradient(from 210deg, #22c55e, #0ea5e9, #a855f7, #f97316, #22c55e);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #f9fafb;
      font-weight: 800;
      font-size: 14px;
      box-shadow: 0 0 0 2px rgba(248, 250, 252, 0.9);
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .brand-title {
      font-size: 15px;
      font-weight: 800;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      background: linear-gradient(120deg, #0f172a, #4f46e5, #db2777);
      -webkit-background-clip: text;
      color: transparent;
    }

    body.theme-dark .brand-title {
      background: linear-gradient(120deg, #e5e7eb, #38bdf8, #fb7185);
      -webkit-background-clip: text;
      color: transparent;
    }

    .brand-tagline {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--text-secondary);
    }

    .card {
      position: relative;
      background: radial-gradient(circle at -10% -10%, rgba(129, 140, 248, 0.09), transparent 45%),
                  radial-gradient(circle at 110% 120%, rgba(45, 212, 191, 0.07), transparent 45%),
                  var(--card-bg);
      border-radius: var(--radius-card);
      padding: 16px 16px 12px;
      border: 1px solid var(--card-outline);
      box-shadow:
        0 18px 35px rgba(15, 23, 42, 0.11),
        0 0 0 1px rgba(148, 163, 184, 0.14);
      margin-bottom: 14px;
      overflow: hidden;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      transition:
        transform 0.15s ease,
        box-shadow 0.15s ease,
        border-color 0.15s ease,
        background 0.25s ease;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 0 0, rgba(250, 204, 21, 0.25), transparent 55%);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow:
        0 22px 45px rgba(15, 23, 42, 0.18),
        0 0 0 1px var(--card-glow);
      border-color: rgba(129, 140, 248, 0.65);
    }

    .card:hover::before {
      opacity: 0.75;
    }

    .card-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }

    .card-header {
      font-weight: 800;
      font-size: 15px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--text-primary);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .card-header::before {
      content: "";
      width: 6px;
      height: 20px;
      border-radius: 999px;
      background: linear-gradient(180deg, #f59e0b, #f97316, #22c55e);
      box-shadow: 0 0 0 1px rgba(248, 250, 252, 0.9);
    }

    .card-subtitle {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-style: italic;
    }

    .theme-toggle {
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid var(--button-border);
      background: radial-gradient(circle at 0 0, rgba(251, 191, 36, 0.18), transparent 60%), var(--button-bg);
      color: var(--text-secondary);
      padding: 4px 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.12);
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.2s ease;
    }

    .theme-toggle span {
      font-size: 13px;
    }

    .theme-toggle:active {
      transform: translateY(1px);
      box-shadow: 0 3px 10px rgba(15, 23, 42, 0.18);
    }

    .section-title {
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.14em;
      margin: 10px 0 6px;
      text-transform: uppercase;
      color: var(--text-secondary);
    }

    .section-title::before {
      content: "‚ú∂";
      margin-right: 4px;
      color: var(--accent);
      opacity: 0.8;
    }

    .wallet-line {
      font-size: 13px;
      margin-bottom: 4px;
    }

    .wallet-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      margin-bottom: 2px;
      color: var(--text-primary);
    }

    .wallet-emoji {
      font-size: 16px;
    }

    .wallet-address {
  display: inline-flex;
  align-items: flex-start;
  justify-content: flex-start;
  gap: 6px;
  font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas,
    "Liberation Mono", "Courier New", monospace;
  font-size: 11px;
  padding: 6px 10px;
  background: var(--pill-bg);
  border-radius: 12px;
  border: 1px solid var(--button-border);
  color: var(--text-secondary);
  cursor: pointer;
  user-select: all;
  max-width: 100%;
  /* show full address, allow wrapping */
  white-space: normal;
  word-break: break-all;
  overflow: visible;
  position: relative;

    }

    .wallet-address::after {
  content: "";

    }

    .balances {
      margin-top: 4px;
      padding: 8px 10px;
      border-radius: 12px;
      background: radial-gradient(circle at 0 0, rgba(59, 130, 246, 0.09), transparent 55%), rgba(248, 250, 252, 0.65);
    }

    body.theme-dark .balances {
      background: radial-gradient(circle at 0 0, rgba(59, 130, 246, 0.16), transparent 55%), rgba(15, 23, 42, 0.9);
    }

    .balance-row {
      display: flex;
      align-items: baseline;
      gap: 6px;
      font-size: 13px;
      margin-bottom: 3px;
    }

    .balance-dot {
      font-size: 14px;
    }

    .balance-label {
      flex: 1;
      color: var(--text-secondary);
    }

    .balance-value {
      font-variant-numeric: tabular-nums;
      color: var(--text-primary);
      font-weight: 700;
    }

    .timestamp {
      text-align: right;
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 6px;
    }

    .button-grid {
      margin-top: 14px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 11px 10px;
      border-radius: 999px;
      border: 1px solid var(--button-border);
      background: var(--button-bg);
      color: var(--button-text);
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      cursor: pointer;
      outline: none;
      transition:
        background 0.18s ease,
        border-color 0.18s ease,
        transform 0.1s ease,
        box-shadow 0.15s ease;
    }

    .btn span.icon {
      font-size: 18px;
    }

    .btn:hover {
      background: linear-gradient(135deg, rgba(148, 163, 184, 0.11), transparent);
      box-shadow: 0 9px 20px rgba(15, 23, 42, 0.16);
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.22);
    }

    .btn-primary {
      background: linear-gradient(135deg, #facc15, #fb923c, #22c55e);
      color: #111827;
      border-color: transparent;
      box-shadow:
        0 13px 28px rgba(251, 191, 36, 0.35),
        0 0 0 1px rgba(253, 224, 71, 0.6);
    }

    .btn-primary:hover {
      box-shadow:
        0 18px 36px rgba(251, 191, 36, 0.55),
        0 0 0 1px rgba(251, 146, 60, 0.8);
    }

    .btn-deposit {
      grid-column: span 2;
    }

    .btn-small {
      padding: 8px 10px;
      font-size: 12px;
      text-transform: none;
      letter-spacing: 0.04em;
    }

    .markets-filters {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
      margin-top: 10px;
    }

    .markets-filters .btn {
      font-size: 12px;
      padding: 8px 6px;
      border-radius: 999px;
      background: var(--pill-bg);
    }

    .markets-filters .btn-wide {
      grid-column: span 2;
    }

    .pill-label {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .markets-list {
      margin-top: 10px;
      font-size: 13px;
    }

    .market-item {
      margin-bottom: 10px;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(248, 250, 252, 0.8);
      border: 1px solid rgba(226, 232, 240, 0.8);
      transition: background 0.15s ease, border-color 0.15s ease, transform 0.1s ease;
    }

    body.theme-dark .market-item {
      background: rgba(15, 23, 42, 0.95);
      border-color: rgba(30, 64, 175, 0.7);
    }

    .market-item:hover {
      transform: translateY(-1px);
      border-color: var(--accent);
      background: rgba(255, 255, 255, 0.96);
    }

    body.theme-dark .market-item:hover {
      background: rgba(15, 23, 42, 0.98);
    }

    .market-title {
      font-weight: 600;
      margin-bottom: 2px;
      text-decoration: underline;
      cursor: pointer;
      color: var(--accent-strong);
    }

    .market-line {
      display: flex;
      align-items: baseline;
      gap: 4px;
    }

    .market-label {
      color: var(--text-secondary);
    }

    .market-value {
      font-variant-numeric: tabular-nums;
    }

    .markets-status {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 6px;
    }

    .portfolio-buttons {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .portfolio-buttons .btn-wide {
      grid-column: span 2;
    }

    .portfolio-body {
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-secondary);
      white-space: pre-wrap;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(248, 250, 252, 0.7);
      border: 1px dashed rgba(209, 213, 219, 0.9);
    }

    body.theme-dark .portfolio-body {
      background: rgba(15, 23, 42, 0.9);
      border-color: rgba(55, 65, 81, 0.9);
    }

    .buy-sheet {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      max-width: 420px;
      margin: 0 auto;
      padding: 12px 16px 16px;
      background: var(--card-bg);
      border-top: 1px solid var(--card-outline);
      box-shadow: 0 -18px 40px rgba(15, 23, 42, 0.5);
      border-radius: 18px 18px 0 0;
      z-index: 20;
      display: none;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }

    .buy-sheet.visible {
      display: block;
    }

    .buy-header {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-primary);
    }

    .buy-subtitle {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .buy-price-row {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .buy-buttons {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    @media (max-width: 360px) {
      body {
        padding: 10px;
      }
      .btn {
        font-size: 12px;
        padding-block: 9px;
      }
      .wallet-address {
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="brand">
      <div class="brand-mark">PA</div>
      <div class="brand-text">
        <div class="brand-title">Polyamorous</div>
        <div class="brand-tagline">Polymarket Mini App</div>
      </div>
    </div>

    <!-- WELCOME + WALLETS CARD -->
    <div class="card">
      <div class="card-header-row">
        <div class="card-header">
          WELCOME TO POLYAMOROUS üîÆ
        </div>
        <button class="theme-toggle" id="themeToggle" type="button">
          <span id="themeToggleIcon">‚òÄÔ∏è</span>
          <span id="themeToggleLabel">Light</span>
        </button>
      </div>
      <div class="card-subtitle">
        Prediction markets on Telegram, built on Polymarket.
      </div>

      <div class="section-title">
        üí∞ Deposit to begin trading üí∞
      </div>

      <div class="section-title">Your wallets</div>

      <div class="wallet-line">
        <div class="wallet-label">
          <span class="wallet-emoji">üíé</span> Polygon:
        </div>
        <div id="polygonAddress" class="wallet-address" title="Tap to copy">
          generating‚Ä¶
        </div>
      </div>

      <div class="wallet-line" style="margin-top: 6px;">
        <div class="wallet-label">
          <span class="wallet-emoji">üí≤</span> Solana:
        </div>
        <div id="solanaAddress" class="wallet-address" title="Tap to copy">
          generating‚Ä¶
        </div>
      </div>

      <div class="section-title" style="margin-top: 12px;">Balances</div>
      <div class="balances">
        <div class="balance-row">
          <span class="balance-dot">üî∑</span>
          <span class="balance-label">POL USDC.e available for trades</span>
          <span class="balance-value" id="availableBalance">0.00</span>
        </div>
        <div class="balance-row">
          <span class="balance-dot">üî∑</span>
          <span class="balance-label">Open positions value</span>
          <span class="balance-value" id="openPositions">0.00</span>
        </div>
        <div class="balance-row">
          <span class="balance-dot">üî∑</span>
          <span class="balance-label">Pending limit orders</span>
          <span class="balance-value" id="pendingOrders">0.00</span>
        </div>
      </div>

      <div class="timestamp" id="timestamp"></div>

      <!-- Main navigation buttons -->
      <div class="button-grid">
        <button class="btn btn-primary btn-deposit" id="depositBtn">
          <span class="icon">üí∞</span>
          <span>Deposit</span>
        </button>

        <button class="btn" id="marketsBtn">
          <span class="icon">üìä</span>
          <span>Markets</span>
        </button>

        <button class="btn" id="guideBtn">
          <span class="icon">üí°</span>
          <span>Guide</span>
        </button>

        <button class="btn" id="portfolioBtn">
          <span class="icon">üíº</span>
          <span>Portfolio</span>
        </button>

        <button class="btn" id="walletsBtn">
          <span class="icon">üëõ</span>
          <span>Wallets</span>
        </button>

        <button class="btn" id="updatesBtn">
          <span class="icon">üì£</span>
          <span>Updates</span>
        </button>

        <button class="btn" id="inviteBtn">
          <span class="icon">ü§ù</span>
          <span>Invite</span>
        </button>
      </div>
    </div>

    <!-- MARKETS CARD -->
    <div class="card" id="marketsCard">
      <div class="card-header">üìä Markets</div>
      <div class="pill-label">
        Browse markets on Polyamorous by trend, volume, recency, or category.
      </div>
      <ul style="margin: 6px 0 0 18px; padding: 0; font-size: 13px; color: var(--text-secondary);">
        <li>üî• Trending ‚Äì by 24h volume</li>
        <li>üìà Volume ‚Äì by total volume</li>
        <li>üÜï New ‚Äì recently created</li>
        <li>üìÇ Category ‚Äì by category</li>
        <li>üîç Search ‚Äì (coming soon)</li>
      </ul>

      <div class="markets-filters">
        <button class="btn btn-small" data-markets-filter="trending">üî• TRENDING</button>
        <button class="btn btn-small" data-markets-filter="volume">üìà VOLUME</button>
        <button class="btn btn-small" data-markets-filter="new">üÜï NEW</button>
        <button class="btn btn-small" data-markets-filter="category">üìÇ CATEGORY</button>
        <button class="btn btn-small btn-wide" data-markets-filter="search">üîç SEARCH</button>
      </div>

      <div class="section-title" style="margin-top: 12px;">
        üÜï Markets
      </div>
      <div class="markets-list" id="marketsList">
        Loading markets‚Ä¶
      </div>
      <div class="markets-status" id="marketsStatus"></div>
    </div>

    <!-- PORTFOLIO CARD -->
    <div class="card">
      <div class="card-header">üíº Portfolio</div>
      <div class="pill-label">
        View your live positions, limit orders, and on-chain activity.
      </div>

      <div class="portfolio-buttons">
        <button class="btn btn-small" id="positionsBtn">üíº POSITIONS</button>
        <button class="btn btn-small" id="ordersBtn">üìã ORDERS</button>
        <button class="btn btn-small btn-wide" id="historyBtn">üßæ HISTORY</button>
      </div>

      <div class="portfolio-body" id="portfolioBody">
        Tap a tab above to load your data.
      </div>
    </div>
  </div>

  <!-- BUY YES / BUY NO bottom sheet -->
  <div class="buy-sheet" id="buySheet">
    <div class="buy-header" id="buyTitle">Market title</div>
    <div class="buy-subtitle" id="buySubtitle">Pick YES or NO to place an order.</div>
    <div class="buy-price-row" id="buyPriceRow"></div>
    <div class="buy-buttons">
      <button class="btn btn-primary" id="buyYesBtn">üü¢ BUY YES</button>
      <button class="btn" id="buyNoBtn">üî¥ BUY NO</button>
    </div>
  </div>

  <!-- Telegram API & crypto libs -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.0/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

  <script>
    const tg = window.Telegram ? window.Telegram.WebApp : null;
    if (tg) tg.ready();

    const appState = {
      polygonAddress: null,
      currentMarket: null,
      theme: "light",
    };

    // -------- Theme toggle --------
    function applyTheme(theme) {
      const body = document.body;
      if (theme === "dark") {
        body.classList.add("theme-dark");
      } else {
        body.classList.remove("theme-dark");
      }
      appState.theme = theme;
      const icon = document.getElementById("themeToggleIcon");
      const label = document.getElementById("themeToggleLabel");
      if (theme === "dark") {
        icon.textContent = "üåô";
        label.textContent = "Dark";
      } else {
        icon.textContent = "‚òÄÔ∏è";
        label.textContent = "Light";
      }
      try {
        localStorage.setItem("polyamorousTheme", theme);
      } catch (_) {}
    }

    function initTheme() {
      let saved = null;
      try {
        saved = localStorage.getItem("polyamorousTheme");
      } catch (_) {}
      if (saved === "dark" || saved === "light") {
        applyTheme(saved);
      } else {
        applyTheme("light"); // default
      }
    }

    // -------- Wallets & balances --------
    function loadOrCreateWallets() {
      const existing = window.localStorage.getItem("polyamorousWallets");
      if (existing) {
        try { return JSON.parse(existing); } catch (e) {}
      }

      const polygonWallet = ethers.Wallet.createRandom();
      const solanaKeypair = solanaWeb3.Keypair.generate();

      const wallets = {
        polygon: {
          address: polygonWallet.address,
          privateKey: polygonWallet.privateKey
        },
        solana: {
          publicKey: solanaKeypair.publicKey.toBase58(),
          secretKey: Array.from(solanaKeypair.secretKey)
        }
      };

      window.localStorage.setItem("polyamorousWallets", JSON.stringify(wallets));
      return wallets;
    }

    function truncateAddress(addr, start = 6, end = 4) {
      if (!addr || addr.length <= start + end) return addr;
      return addr.slice(0, start) + "‚Ä¶" + addr.slice(-end);
    }

    function copyToClipboard(text) {
      if (!navigator.clipboard) return;
      navigator.clipboard.writeText(text).catch(() => {});
    }

    async function refreshServerBalances(polygonAddress) {
      try {
        const res = await fetch(`/api/balances?address=${encodeURIComponent(polygonAddress)}`);
        if (!res.ok) throw new Error("http " + res.status);
        const data = await res.json();
        const fmt = (n) => Number(n || 0).toFixed(2);

        document.getElementById("availableBalance").textContent =
          fmt(data.usdcAvailable);
        document.getElementById("openPositions").textContent =
          fmt(data.openPositionsValue);
        document.getElementById("pendingOrders").textContent =
          fmt(data.pendingOrdersValue);
      } catch (err) {
        console.error("refreshServerBalances error", err);
      }
    }

    async function fetchDepositAddresses(polygonAddress) {
      try {
        const res = await fetch(`/api/deposit?address=${encodeURIComponent(polygonAddress)}`, {
          method: "POST"
        });
        if (!res.ok) throw new Error("http " + res.status);
        return await res.json();
      } catch (err) {
        console.error("fetchDepositAddresses error", err);
        tg?.showAlert("Could not get deposit addresses. Try again.");
        return null;
      }
    }

    // -------- Market helpers --------
    function formatDollarsShort(value) {
      const n = Number(value || 0);
      if (!isFinite(n)) return "N/A";
      if (n >= 1_000_000) return "$" + (n / 1_000_000).toFixed(1) + "M";
      if (n >= 1_000) return "$" + (n / 1_000).toFixed(1) + "k";
      return "$" + n.toFixed(1);
    }

    function formatEnds(endDateIso) {
      if (!endDateIso) return "N/A";
      const d = new Date(endDateIso);
      if (isNaN(d.getTime())) return "N/A";

      const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const day = d.getDate();
      const suffix = (day % 10 === 1 && day !== 11) ? "st"
        : (day % 10 === 2 && day !== 12) ? "nd"
        : (day % 10 === 3 && day !== 13) ? "rd" : "th";

      return `${monthNames[d.getMonth()]} ${day}${suffix}, ${d.getFullYear()}`;
    }

    function computeYesNoPrices(market) {
      const p = market.bestAsk ?? market.lastTradePrice ?? null;
      if (p == null) {
        return { yes: "50.00c", no: "50.00c" };
      }
      const yesCents = p * 100;
      const noCents = 100 - yesCents;
      return {
        yes: yesCents.toFixed(2) + "c",
        no: noCents.toFixed(2) + "c"
      };
    }

    // local pass-through; backend handles filtering
    function filterMarketsLocally(markets) {
      return markets || [];
    }

    // -------- Fetch markets (with category support) --------
    async function fetchMarkets(kind = "new", limit = 5, categorySlug = null) {
      const statusEl = document.getElementById("marketsStatus");
      try {
        const qs = new URLSearchParams();
        qs.set("kind", kind);
        qs.set("limit", String(limit));
        if (categorySlug) qs.set("category", categorySlug);

        statusEl.textContent = `Loading ${kind} markets‚Ä¶`;
        const res = await fetch(`/api/markets?${qs.toString()}`);
        if (!res.ok) throw new Error("http " + res.status);
        const data = await res.json();
        let markets = Array.isArray(data) ? data : (data.markets || []);
        markets = filterMarketsLocally(markets);
        statusEl.textContent = `Showing ${kind} markets`;
        return markets;
      } catch (err) {
        console.error("fetchMarkets error", err);
        statusEl.textContent = "Error loading markets.";
        return [];
      }
    }

    // -------- Categories helper --------
    async function pickCategoryAndLoad() {
      try {
        const res = await fetch("/api/categories");
        if (!res.ok) throw new Error("http " + res.status);
        const json = await res.json();
        const cats = json.categories || [];
        if (!cats.length) {
          tg?.showAlert?.("No categories available right now.");
          return;
        }

        if (tg && typeof tg.showPopup === "function") {
          const buttons = cats.slice(0, 7).map((c) => ({
            id: c.slug,
            type: "default",
            text: c.label,
          }));

          tg.showPopup(
            {
              title: "Choose a category",
              buttons: [...buttons, { id: "cancel", type: "cancel", text: "Cancel" }],
            },
            async (buttonId) => {
              if (!buttonId || buttonId === "cancel") return;
              const markets = await fetchMarkets("category", 10, buttonId);
              renderMarketsList(markets);
            }
          );
        } else {
          const names = cats.map((c) => c.label).join(", ");
          const chosen = prompt("Category (" + names + "):");
          if (!chosen) return;

          const slug =
            cats.find((c) => c.label.toLowerCase() === chosen.toLowerCase())?.slug ||
            chosen.toLowerCase().replace(/\s+/g, "-");

          const markets = await fetchMarkets("category", 10, slug);
          renderMarketsList(markets);
        }
      } catch (e) {
        console.error("pickCategoryAndLoad error", e);
        tg?.showAlert?.("Failed to load categories.");
      }
    }

    // -------- Render markets --------
    function renderMarketsList(markets) {
      const container = document.getElementById("marketsList");
      if (!markets.length) {
        container.textContent = "No markets found.";
        return;
      }

      container.innerHTML = "";
      markets.slice(0, 10).forEach((m, idx) => {
        const div = document.createElement("div");
        div.className = "market-item";

        const title = m.question || m.title || "Untitled market";
        const liquidity = m.liquidityNum ?? m.liquidity ?? m.liquidityClob ?? m.liquidityAmm;
        const volume = m.volume24hr ?? m.volumeNum ?? m.volume ?? null;
        const end = m.endDateIso ?? m.endDate ?? null;
        const prices = computeYesNoPrices(m);

        const titleEl = document.createElement("div");
        titleEl.className = "market-title";
        titleEl.textContent = `${idx + 1}. ${title}`;
        titleEl.addEventListener("click", () => openBuySheet(title, prices, m));
        div.appendChild(titleEl);

        const liqRow = document.createElement("div");
        liqRow.className = "market-line";
        liqRow.innerHTML =
          `<span class="market-label">üìà Liquidity:</span> <span class="market-value">${formatDollarsShort(liquidity)}</span>`;
        div.appendChild(liqRow);

        const volRow = document.createElement("div");
        volRow.className = "market-line";
        volRow.innerHTML =
          `<span class="market-label">üöÄ Volume (24h):</span> <span class="market-value">${volume != null ? formatDollarsShort(volume) : "N/A"}</span>`;
        div.appendChild(volRow);

        const endsRow = document.createElement("div");
        endsRow.className = "market-line";
        endsRow.innerHTML =
          `<span class="market-label">üìÖ Ends:</span> <span class="market-value">${formatEnds(end)}</span>`;
        div.appendChild(endsRow);

        const priceRow = document.createElement("div");
        priceRow.className = "market-line";
        priceRow.innerHTML =
          `<span class="market-label">üí∞ Cost YES:</span> <span class="market-value">${prices.yes}</span> ¬∑ ` +
          `<span class="market-label">Cost NO:</span> <span class="market-value">${prices.no}</span>`;
        div.appendChild(priceRow);

        container.appendChild(div);
      });
    }

    // -------- Buy sheet (detail) --------
    function openBuySheet(title, prices, market) {
      appState.currentMarket = market;
      const sheet = document.getElementById("buySheet");
      document.getElementById("buyTitle").textContent = title;
      document.getElementById("buySubtitle").textContent =
        "Status: Open ¬∑ Order placement uses Polyamorous backend.";
      document.getElementById("buyPriceRow").textContent =
        `Yes: ${prices.yes} ¬∑ No: ${prices.no}`;
      sheet.classList.add("visible");
    }

    function closeBuySheet() {
      const sheet = document.getElementById("buySheet");
      sheet.classList.remove("visible");
      appState.currentMarket = null;
    }

    async function placeOrderForCurrentMarket(outcomeSide) {
      const m = appState.currentMarket;
      if (!m) {
        alert("No market selected.");
        return;
      }
      const tokenIds = m.clobTokenIds || m.tokenIds || [];
      if (!tokenIds.length) {
        alert("This market does not expose CLOB token IDs in the payload.");
        return;
      }

      const yesTokenId = tokenIds[0];
      const noTokenId = tokenIds[1] || tokenIds[0];
      const tokenId = outcomeSide === "YES" ? yesTokenId : noTokenId;

      const size = 10;
      const price = 0.5;

      try {
        const res = await fetch("/api/trade", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            tokenId,
            side: "BUY",
            price,
            size,
            tickSize: "0.001",
            negRisk: !!m.negativeRisk,
          }),
        });

        const json = await res.json();
        if (!res.ok || !json.ok) {
          console.error("Trade failed", json);
          alert("Order failed: " + (json.error || "unknown error"));
          return;
        }

        alert("Order submitted ‚úÖ");
        closeBuySheet();
      } catch (e) {
        console.error(e);
        alert("Network error while placing order");
      }
    }

    // -------- Portfolio --------
    async function loadPortfolioSection(section) {
      if (!appState.polygonAddress) {
        alert("Wallet not ready yet.");
        return;
      }

      const addr = appState.polygonAddress;
      let endpoint;
      if (section === "positions") endpoint = "/api/positions";
      else if (section === "orders") endpoint = "/api/trades";
      else endpoint = "/api/activity";

      const bodyEl = document.getElementById("portfolioBody");
      bodyEl.textContent = "Loading‚Ä¶";

      try {
        const res = await fetch(`${endpoint}?user=${encodeURIComponent(addr)}`);
        const json = await res.json();
        if (!res.ok) throw new Error(json.error || "Request failed");

        if (section === "positions") {
          renderPositions(bodyEl, json.positions || []);
        } else if (section === "orders") {
          renderTrades(bodyEl, json.trades || []);
        } else {
          renderActivity(bodyEl, json.activity || []);
        }
      } catch (e) {
        console.error(e);
        bodyEl.textContent = "Error loading data.";
      }
    }

    function renderPositions(container, positions) {
      if (!positions.length) {
        container.textContent = "No open positions.";
        return;
      }
      const lines = positions.slice(0, 10).map((p, i) => {
        const sz = Number(p.size || 0).toFixed(2);
        const pnl = Number(p.cashPnl || 0).toFixed(2);
        return `${i + 1}. ${p.title || p.slug} ‚Äì ${p.outcome} | Size: ${sz} | PnL: $${pnl}`;
      });
      container.textContent = lines.join("\n");
    }

    function renderTrades(container, trades) {
      if (!trades.length) {
        container.textContent = "No trades yet.";
        return;
      }
      const lines = trades.slice(0, 10).map((t, i) => {
        const sz = Number(t.size || 0).toFixed(2);
        const px = Number(t.price || 0).toFixed(3);
        return `${i + 1}. ${t.title || t.slug} ‚Äì ${t.outcome} ‚Äì ${t.side} ${sz} @ $${px}`;
      });
      container.textContent = lines.join("\n");
    }

    function renderActivity(container, activity) {
      if (!activity.length) {
        container.textContent = "No activity yet.";
        return;
      }
      const lines = activity.slice(0, 10).map((a, i) => {
        const ts = a.timestamp ? new Date(a.timestamp * 1000).toLocaleString() : "";
        const kind = a.type || "EVENT";
        return `${i + 1}. [${kind}] ${a.title || a.slug} ‚Äì ${a.outcome || ""} ‚Äì ${ts}`;
      });
      container.textContent = lines.join("\n");
    }

    // -------- UI init --------
    function initUI() {
      initTheme();

      const themeToggle = document.getElementById("themeToggle");
      themeToggle.onclick = () => {
        const next = appState.theme === "dark" ? "light" : "dark";
        applyTheme(next);
      };

      const wallets = loadOrCreateWallets();

      const polygonAddressEl = document.getElementById("polygonAddress");
      const solanaAddressEl = document.getElementById("solanaAddress");

      polygonAddressEl.textContent = truncateAddress(wallets.polygon.address);
      polygonAddressEl.addEventListener("click", () => {
        copyToClipboard(wallets.polygon.address);
        tg?.HapticFeedback?.impactOccurred("light");
      });

      solanaAddressEl.textContent = truncateAddress(wallets.solana.publicKey);
      solanaAddressEl.addEventListener("click", () => {
        copyToClipboard(wallets.solana.publicKey);
        tg?.HapticFeedback?.impactOccurred("light");
      });

      appState.polygonAddress = wallets.polygon.address;

      const tsEl = document.getElementById("timestamp");
      const now = new Date();
      tsEl.textContent = now.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });

      refreshServerBalances(wallets.polygon.address);

      // Deposit + nav buttons
      document.getElementById("depositBtn").onclick = async () => {
        const resp = await fetchDepositAddresses(wallets.polygon.address);
        if (!resp) return;

        const lines = (resp.depositAddresses || []).map((d) =>
          `${d.chainName || d.chain || ""} ‚Äì ${d.tokenSymbol || ""}\n${d.depositAddress}`
        );

        const msg =
          "Send supported tokens to one of these addresses:\n\n" +
          (lines.length ? lines.join("\n\n") : "No deposit routes received.");

        if (tg) tg.showAlert(msg.slice(0, 1024));
        else alert(msg);
      };

      document.getElementById("marketsBtn").onclick = () =>
        document.getElementById("marketsCard").scrollIntoView({ behavior: "smooth" });

      document.getElementById("guideBtn").onclick = () =>
        tg?.openLink?.("https://docs.polymarket.com/polymarket-learn/get-started/how-to-deposit");

      document.getElementById("portfolioBtn").onclick = () =>
        document.querySelectorAll(".card")[2].scrollIntoView({ behavior: "smooth" });

      document.getElementById("walletsBtn").onclick = () =>
        window.scrollTo({ top: 0, behavior: "smooth" });

      document.getElementById("updatesBtn").onclick = () =>
        tg?.openLink?.("https://docs.polymarket.com/changelog");

      document.getElementById("inviteBtn").onclick = () =>
        tg?.openTelegramLink?.("https://t.me/polyamorousbot");

      // Markets filters
      document.querySelectorAll("[data-markets-filter]").forEach((btn) => {
        const kind = btn.getAttribute("data-markets-filter");

        if (kind === "category") {
          btn.addEventListener("click", () => {
            pickCategoryAndLoad();
          });
          return;
        }

        if (kind === "search") {
          btn.addEventListener("click", () => {
            tg?.showAlert?.("Search is coming soon.");
          });
          return;
        }

        btn.addEventListener("click", async () => {
          const mappedKind = kind === "new" ? "new" : kind; // trending / volume / new
          const markets = await fetchMarkets(mappedKind, 10);
          renderMarketsList(markets);
        });
      });

      // Load default "new" markets
      fetchMarkets("new", 10).then(renderMarketsList);

      // Portfolio buttons
      document.getElementById("positionsBtn").onclick = () =>
        loadPortfolioSection("positions");
      document.getElementById("ordersBtn").onclick = () =>
        loadPortfolioSection("orders");
      document.getElementById("historyBtn").onclick = () =>
        loadPortfolioSection("history");

      // Buy sheet buttons
      document.getElementById("buyYesBtn").onclick = () =>
        placeOrderForCurrentMarket("YES");
      document.getElementById("buyNoBtn").onclick = () =>
        placeOrderForCurrentMarket("NO");

      // Close sheet if user taps outside
      document.getElementById("buySheet").addEventListener("click", (e) => {
        if (e.target.id === "buySheet") closeBuySheet();
      });

      // Close on ESC
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeBuySheet();
      });
    }

    document.addEventListener("DOMContentLoaded", initUI);
  </script>
</body>
</html>
